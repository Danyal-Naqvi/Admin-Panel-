name: CI/CD Pipeline - Lawyer Hub Admin Panel

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    # ------------------ Build Backend ------------------
    - name: Install Backend Dependencies
      working-directory: ./backend
      run: npm install

    - name: Build Backend (if needed)
      working-directory: ./backend
      run: |
        if [ -f "package.json" ] && grep -q "\"build\"" package.json; then
          npm run build
        else
          echo "No build script for backend - skipping"
        fi

    # ------------------ Build Frontend ------------------
    - name: Install Frontend Dependencies
      working-directory: ./client
      run: npm install

    - name: Build Frontend React App
      working-directory: ./client
      run: npm run build
      env:
        REACT_APP_API_BASE: http://13.92.68.107:4000
        CI: false

    # ------------------ Docker Login ------------------
    - name: Docker Login
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # ------------------ Build & Push Backend Image ------------------
    - name: Build Backend Docker Image
      run: |
        docker build -t danyalali123/backend-app:latest ./backend
        echo "âœ… Backend image built successfully"

    - name: Push Backend Docker Image
      run: |
        docker push danyalali123/backend-app:latest
        echo "âœ… Backend image pushed to Docker Hub"

    # ------------------ Build & Push Frontend Image ------------------
    - name: Build Frontend Docker Image
      run: |
        docker build -t danyalali123/frontend-app:latest ./client
        echo "âœ… Frontend image built successfully"

    - name: Push Frontend Docker Image
      run: |
        docker push danyalali123/frontend-app:latest
        echo "âœ… Frontend image pushed to Docker Hub"

    # ------------------ Deploy to Azure Kubernetes (AKS) ------------------
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Configure AKS Credentials
      uses: azure/aks-set-context@v3
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        cluster-name: DevOpsAKSCluster
        resource-group: DevOpsExamRG

    - name: Deploy Backend to AKS
      run: |
        kubectl apply -f ./k8s-manifests/backend-deployment.yaml
        kubectl rollout status deployment/backend-deployment
        echo "âœ… Backend deployed to AKS"

    - name: Deploy Frontend to AKS
      run: |
        kubectl apply -f ./k8s-manifests/frontend-deployment.yaml
        kubectl rollout status deployment/frontend-deployment
        echo "âœ… Frontend deployed to AKS"

    - name: Apply Services
      run: |
        kubectl apply -f ./k8s-manifests/services.yaml
        echo "âœ… Services configured"

    - name: Get Deployment Status
      run: |
        echo "=== Deployments ==="
        kubectl get deployments
        echo ""
        echo "=== Services ==="
        kubectl get services
        echo ""
        echo "=== Pods ==="
        kubectl get pods

    - name: Deployment Summary
      run: |
        echo "ðŸŽ‰ Deployment completed successfully!"
        echo ""
        echo "Frontend URL: http://48.194.84.98/"
        echo "Backend API: http://13.92.68.107:4000"
